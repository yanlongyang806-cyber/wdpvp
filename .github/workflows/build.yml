name: Build NNO GameServer

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: List files for debugging
      run: |
        Write-Host "=== Repository Structure ==="
        Get-ChildItem -Recurse -File | Select-Object FullName | ForEach-Object {
          $relPath = $_.FullName.Replace("$PWD\", "")
          Write-Host $relPath
        } | Select-Object -First 50
        Write-Host "`n=== Looking for .vcxproj files ==="
        Get-ChildItem -Recurse -Filter "*.vcxproj" -ErrorAction SilentlyContinue | ForEach-Object {
          $relPath = $_.FullName.Replace("$PWD\", "")
          Write-Host "Found: $relPath"
        }
        
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Build GameServerLib
      run: |
        Write-Host "=== Building GameServerLib ==="
        $libPaths = @(
          "src\CrossRoads\GameServerLib\GameServerLib.vcxproj",
          "CrossRoads\GameServerLib\GameServerLib.vcxproj"
        )
        $built = $false
        foreach ($path in $libPaths) {
          if (Test-Path $path) {
            Write-Host "Found project file: $path"
            Write-Host "Building..."
            msbuild $path /p:Configuration=Release /p:Platform=Win32 /m /v:minimal /t:Rebuild
            if ($LASTEXITCODE -eq 0) {
              Write-Host "✓ GameServerLib built successfully"
              $built = $true
              break
            } else {
              Write-Host "✗ Build failed with exit code: $LASTEXITCODE"
            }
          }
        }
        if (-not $built) {
          Write-Host "⚠ GameServerLib.vcxproj not found or build failed"
        }
      continue-on-error: true
      
    - name: Build GameServer
      run: |
        Write-Host "=== Building GameServer ==="
        $gameServerPaths = @(
          "src\Night\GameServer\NNOGameServer.vcxproj",
          "Night\GameServer\NNOGameServer.vcxproj",
          "GameServer\NNOGameServer.vcxproj"
        )
        $built = $false
        foreach ($path in $gameServerPaths) {
          if (Test-Path $path) {
            Write-Host "Found project file: $path"
            Write-Host "Building..."
            msbuild $path /p:Configuration=Release /p:Platform=Win32 /m /v:minimal /t:Rebuild
            if ($LASTEXITCODE -eq 0) {
              Write-Host "✓ GameServer built successfully"
              $built = $true
              break
            } else {
              Write-Host "✗ Build failed with exit code: $LASTEXITCODE"
            }
          }
        }
        if (-not $built) {
          Write-Host "⚠ NNOGameServer.vcxproj not found or build failed"
        }
      continue-on-error: true
      
    - name: Deep Search for Build Outputs
      run: |
        Write-Host "=== Deep Search for Build Outputs ==="
        Write-Host "`n[1] Searching for ALL .exe files (entire repository):"
        $allExes = Get-ChildItem -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue
        if ($allExes) {
          foreach ($exe in $allExes) {
            $relPath = $exe.FullName.Replace("$PWD\", "")
            $sizeMB = [math]::Round($exe.Length / 1MB, 2)
            $date = $exe.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")
            Write-Host "  ✓ $relPath ($sizeMB MB) [$date]"
          }
        } else {
          Write-Host "  ✗ No .exe files found in repository"
        }
        
        Write-Host "`n[2] Checking specific output directories:"
        $outputPaths = @(
          "bin",
          "Bin",
          "BIN",
          "src\bin",
          "src\Bin",
          "Night\bin",
          "Night\Bin",
          "src\Night\bin",
          "src\Night\Bin",
          "GameServer\bin",
          "GameServer\Bin",
          "src\Night\GameServer\bin",
          "Night\GameServer\bin",
          "obj",
          "Obj",
          "OBJ",
          "src\obj",
          "Night\GameServer\obj",
          "src\Night\GameServer\obj",
          "Release",
          "release",
          "Debug",
          "debug",
          "x64\Release",
          "x64\Debug",
          "Win32\Release",
          "Win32\Debug"
        )
        
        foreach ($path in $outputPaths) {
          if (Test-Path $path) {
            Write-Host "  ✓ Directory exists: $path"
            $files = Get-ChildItem -Path $path -Recurse -File -ErrorAction SilentlyContinue
            if ($files) {
              Write-Host "    Files in $path :"
              foreach ($file in $files) {
                $relPath = $file.FullName.Replace("$PWD\", "")
                Write-Host "      - $relPath ($([math]::Round($file.Length / 1KB, 2)) KB)"
              }
            } else {
              Write-Host "    (empty)"
            }
          }
        }
        
        Write-Host "`n[3] Searching for GameServer*.exe specifically:"
        $gameServerExes = Get-ChildItem -Recurse -Filter "GameServer*.exe" -ErrorAction SilentlyContinue
        if ($gameServerExes) {
          foreach ($exe in $gameServerExes) {
            $relPath = $exe.FullName.Replace("$PWD\", "")
            $sizeMB = [math]::Round($exe.Length / 1MB, 2)
            Write-Host "  ✓ FOUND: $relPath ($sizeMB MB)"
          }
        } else {
          Write-Host "  ✗ GameServer*.exe not found"
        }
        
        Write-Host "`n[4] Checking if compilation actually happened:"
        $builtDirs = @(
          "**/bin",
          "**/obj",
          "**/Release",
          "**/Debug",
          "**/.vs",
          "**/*.pdb"
        )
        $foundBuildArtifacts = $false
        foreach ($pattern in $builtDirs) {
          $items = Get-ChildItem -Path $pattern -Recurse -ErrorAction SilentlyContinue | Select-Object -First 5
          if ($items) {
            Write-Host "  ✓ Found build artifacts matching: $pattern"
            $foundBuildArtifacts = $true
          }
        }
        if (-not $foundBuildArtifacts) {
          Write-Host "  ✗ No build artifacts found - compilation likely did not execute"
        }
        
    - name: Upload GameServer.exe (primary)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: GameServer-Executables
        path: |
          **/bin/**/*.exe
          **/Bin/**/*.exe
          **/Release/**/*.exe
          **/Debug/**/*.exe
          **/obj/**/Release/**/*.exe
          **/obj/**/Debug/**/*.exe
          GameServer*.exe
          GameServerFD*.exe
        if-no-files-found: warn
        retention-days: 30
        
    - name: Upload ALL .exe files (fallback - entire repository)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: All-Executables-Full-Repo
        path: |
          **/*.exe
        if-no-files-found: warn
        retention-days: 7
        
    - name: Upload build outputs directory (if exists)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Build-Output-Directories
        path: |
          bin/
          Bin/
          src/bin/
          Night/bin/
          obj/
          Release/
          Debug/
        if-no-files-found: ignore
        retention-days: 7
