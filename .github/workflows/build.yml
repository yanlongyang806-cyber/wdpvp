name: Build NNO GameServer

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: List files for debugging
      run: |
        Write-Host "=== Repository Structure ==="
        Get-ChildItem -Recurse | Select-Object FullName | ForEach-Object {
          $relPath = $_.FullName.Replace("$PWD\", "")
          Write-Host $relPath
        }
        
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Build GameServerLib
      run: |
        Write-Host "Building GameServerLib (contains modified pvp_common.c)..."
        if (Test-Path "CrossRoads\GameServerLib\GameServerLib.vcxproj") {
          msbuild CrossRoads\GameServerLib\GameServerLib.vcxproj /p:Configuration=Release /p:Platform=Win32 /m /v:minimal
        } elseif (Test-Path "src\CrossRoads\GameServerLib\GameServerLib.vcxproj") {
          msbuild src\CrossRoads\GameServerLib\GameServerLib.vcxproj /p:Configuration=Release /p:Platform=Win32 /m /v:minimal
        } else {
          Write-Host "GameServerLib.vcxproj not found"
        }
      continue-on-error: true
      
    - name: Build GameServer
      run: |
        Write-Host "Building GameServer..."
        if (Test-Path "src\Night\GameServer\NNOGameServer.vcxproj") {
          msbuild src\Night\GameServer\NNOGameServer.vcxproj /p:Configuration=Release /p:Platform=Win32 /m /v:minimal
        } elseif (Test-Path "GameServer\NNOGameServer.vcxproj") {
          msbuild GameServer\NNOGameServer.vcxproj /p:Configuration=Release /p:Platform=Win32 /m /v:minimal
        } else {
          Write-Host "NNOGameServer.vcxproj not found in expected locations"
        }
      continue-on-error: true
      
    - name: Upload GameServer.exe artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: GameServer.exe
        path: |
          bin/GameServer.exe
          bin/GameServerFD.exe
          **/bin/GameServer.exe
          **/bin/GameServerFD.exe
        if-no-files-found: ignore
        retention-days: 30
