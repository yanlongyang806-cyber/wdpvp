name: Build NNO GameServer (Final Full Version)

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: List all repository files
      run: |
        Write-Host "=== Repository Structure ==="
        Get-ChildItem -Recurse -File | Select-Object FullName
        
    - name: Find all project files
      run: |
        Write-Host "=== Searching for .vcxproj files ==="
        Get-ChildItem -Recurse -Filter "*.vcxproj" | ForEach-Object {
          Write-Host "Found project: $($_.FullName)"
        }

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1


    # ----------------------------------------------
    #    Build GameServerLib  (如果不存在则跳过)
    # ----------------------------------------------
    - name: Build GameServerLib
      run: |
        Write-Host "=== Building GameServerLib ==="
        $paths = @(
          "CrossRoads\GameServerLib\GameServerLib.vcxproj",
          "src\CrossRoads\GameServerLib\GameServerLib.vcxproj"
        )
        $built = $false
        
        foreach ($p in $paths) {
          if (Test-Path $p) {
            Write-Host "Building GameServerLib: $p"
            msbuild $p /p:Configuration=Release /p:Platform=Win32 /m /v:minimal
            $built = $true
            break
          }
        }
        
        if (-not $built) {
          Write-Host "⚠ GameServerLib NOT found — skipped"
        }
      continue-on-error: true


    # ----------------------------------------------
    #    Build GameServer 主程序
    # ----------------------------------------------
    - name: Build GameServer
      run: |
        Write-Host "=== Building GameServer ==="
        $paths = @(
          "src\Night\GameServer\NNOGameServer.vcxproj",
          "Night\GameServer\NNOGameServer.vcxproj",
          "GameServer\NNOGameServer.vcxproj",
          "src\Night\GameServer\GameServer.vcxproj",
          "Night\GameServer\GameServer.vcxproj"
        )
        $built = $false
        
        foreach ($p in $paths) {
          if (Test-Path $p) {
            Write-Host "Building GameServer: $p"
            msbuild $p /p:Configuration=Release /p:Platform=Win32 /m /v:minimal
            $built = $true
            break
          }
        }
        
        if (-not $built) {
          Write-Host "❌ ERROR: No GameServer project found!"
        }
      continue-on-error: false


    # ----------------------------------------------
    #    显示所有 Release 输出
    # ----------------------------------------------
    - name: Show Release outputs
      run: |
        Write-Host "=== Searching for Release/Debug outputs ==="
        Get-ChildItem -Recurse -Directory -Filter "Release" | ForEach-Object {
          Write-Host ""
          Write-Host "Release folder: $($_.FullName)"
          Get-ChildItem $_.FullName -File | ForEach-Object {
            Write-Host "  Output: $($_.Name)"
          }
        }
        Get-ChildItem -Recurse -Directory -Filter "Debug" | ForEach-Object {
          Write-Host ""
          Write-Host "Debug folder: $($_.FullName)"
          Get-ChildItem $_.FullName -File | ForEach-Object {
            Write-Host "  Output: $($_.Name)"
          }
        }


    # ----------------------------------------------
    #    上传所有 exe 作为构建产物
    # ----------------------------------------------
    - name: Upload ALL Server Executables
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: GameServer-Build
        path: |
          **/*.exe
          **/Release/**
          **/Debug/**
          src/**/Release/**
          src/**/Debug/**
        if-no-files-found: warn
        retention-days: 30
