name: Verify Source Code

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  verify:
    name: Verify Modified Source Code
    runs-on: windows-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Display repository structure
      run: |
        Write-Host "=== Repository Structure ==="
        Get-ChildItem -Recurse -File | Select-Object FullName | ForEach-Object {
          $relPath = $_.FullName.Replace("$PWD\", "")
          Write-Host "  - $relPath"
        }
        
    - name: Verify pvp_common.c exists
      run: |
        Write-Host "=== Verifying pvp_common.c ==="
        if (Test-Path "CrossRoads/Common/pvp_common.c") {
          Write-Host "✓ pvp_common.c found"
          $file = Get-Item "CrossRoads/Common/pvp_common.c"
          Write-Host "  File size: $([math]::Round($file.Length / 1KB, 2)) KB"
        } else {
          Write-Host "✗ pvp_common.c NOT found!"
          exit 1
        }
        
    - name: Verify modification in pvp_common.c
      run: |
        Write-Host "=== Verifying Modification ==="
        $content = Get-Content "CrossRoads/Common/pvp_common.c" -Raw
        
        if ($content -match "Force PvP.*If both entities are players") {
          Write-Host "✓ Force PvP modification found"
        } else {
          Write-Host "✗ Force PvP modification NOT found!"
          exit 1
        }
        
        if ($content -match "Check if both are players") {
          Write-Host "✓ Player check modification found"
        } else {
          Write-Host "✗ Player check modification NOT found!"
          exit 1
        }
        
        if ($content -match "kEntityRelation_Foe") {
          Write-Host "✓ Foe relation return found"
        } else {
          Write-Host "✗ Foe relation return NOT found!"
          exit 1
        }
        
        Write-Host "`n✓ All modifications verified successfully!"
        
    - name: Check for Chinese characters
      run: |
        Write-Host "=== Checking for Chinese Characters ==="
        $content = Get-Content "CrossRoads/Common/pvp_common.c" -Raw -Encoding UTF8
        
        # Check for Chinese characters (Unicode range 4E00-9FFF)
        if ($content -match "[\u4e00-\u9fff]") {
          Write-Host "⚠ WARNING: Chinese characters found in source code!"
          Write-Host "  This may cause compilation issues."
          exit 1
        } else {
          Write-Host "✓ No Chinese characters found - code is safe for compilation"
        }
        
    - name: Display modification context
      run: |
        Write-Host "=== Modification Context ==="
        $lines = Get-Content "CrossRoads/Common/pvp_common.c"
        $found = $false
        for ($i = 0; $i -lt $lines.Count; $i++) {
          if ($lines[$i] -match "Force PvP") {
            $found = $true
            Write-Host "`nModified code around line $($i+1):"
            $start = [Math]::Max(0, $i - 2)
            $end = [Math]::Min($lines.Count - 1, $i + 8)
            for ($j = $start; $j -le $end; $j++) {
              $marker = if ($j -eq $i) { ">>>" } else { "   " }
              Write-Host "$marker $($j+1): $($lines[$j])"
            }
            break
          }
        }
        if (-not $found) {
          Write-Host "⚠ Modification not found in expected location"
        }
        
    - name: Create summary
      run: |
        Write-Host "`n=== Verification Summary ==="
        Write-Host "✓ Source code file present"
        Write-Host "✓ Modification verified"
        Write-Host "✓ No Chinese characters"
        Write-Host "`nNOTE: This repository contains only the modified source file."
        Write-Host "To compile GameServer.exe, you need:"
        Write-Host "  1. The complete source code repository"
        Write-Host "  2. Replace CrossRoads/Common/pvp_common.c with this file"
        Write-Host "  3. Build GameServerLib first, then GameServer.exe"
        Write-Host "`nSee BUILD_GAMESERVER.md for detailed compilation instructions."
