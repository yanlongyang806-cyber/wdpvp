name: Build NNO GameServer (Fixed Path)

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: List repository structure
      run: |
        Write-Host "=== Full Repository Structure ==="
        Get-ChildItem -Recurse -File | Select-Object FullName | ForEach-Object {
          $relPath = $_.FullName.Replace("$PWD\", "")
          Write-Host $relPath
        }
        
    - name: Find project files
      run: |
        Write-Host "=== Searching for .vcxproj files ==="
        Get-ChildItem -Recurse -Filter "*.vcxproj" | ForEach-Object {
          $relPath = $_.FullName.Replace("$PWD\", "")
          Write-Host "Found: $relPath"
        }
        Write-Host ""
        Write-Host "=== Searching for NNOGameServer ==="
        Get-ChildItem -Recurse -Filter "*NNOGameServer*" | ForEach-Object {
          $relPath = $_.FullName.Replace("$PWD\", "")
          Write-Host "Found: $relPath"
        }
        
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Verify pvp_common.c modification
      run: |
        Write-Host "=== Verifying pvp_common.c modification ==="
        $paths = @(
          "CrossRoads\Common\pvp_common.c",
          "src\CrossRoads\Common\pvp_common.c"
        )
        $found = $false
        foreach ($path in $paths) {
          if (Test-Path $path) {
            Write-Host "✓ Found at: $path"
            $content = Get-Content $path -Raw
            if ($content -match "Force PvP") {
              Write-Host "✓ Modification verified"
              $found = $true
              break
            }
          }
        }
        if (-not $found) {
          Write-Host "⚠ pvp_common.c not found or modification missing"
        }
        
    - name: Build GameServerLib
      run: |
        Write-Host "=== Building GameServerLib ==="
        $libPaths = @(
          "CrossRoads\GameServerLib\GameServerLib.vcxproj",
          "src\CrossRoads\GameServerLib\GameServerLib.vcxproj"
        )
        $built = $false
        foreach ($path in $libPaths) {
          if (Test-Path $path) {
            Write-Host "Building: $path"
            msbuild $path /p:Configuration=Release /p:Platform=Win32 /m /v:minimal
            $built = $true
            break
          }
        }
        if (-not $built) {
          Write-Host "⚠ GameServerLib.vcxproj not found, skipping..."
        }
      continue-on-error: true
      
    - name: Build GameServer
      run: |
        Write-Host "=== Building GameServer ==="
        $gameServerPaths = @(
          "src\Night\GameServer\NNOGameServer.vcxproj",
          "Night\GameServer\NNOGameServer.vcxproj",
          "GameServer\NNOGameServer.vcxproj"
        )
        $built = $false
        foreach ($path in $gameServerPaths) {
          if (Test-Path $path) {
            Write-Host "Building: $path"
            msbuild $path /p:Configuration=Release /p:Platform=Win32 /m /v:minimal
            $built = $true
            break
          }
        }
        if (-not $built) {
          Write-Host "⚠ NNOGameServer.vcxproj not found in any expected location"
          Write-Host "Expected locations:"
          foreach ($path in $gameServerPaths) {
            Write-Host "  - $path"
          }
        }
      continue-on-error: true
      
    - name: Find build output
      run: |
        Write-Host "=== Searching for GameServer.exe ==="
        $searchPaths = @("bin", "src\Night\GameServer\bin", "Night\GameServer\bin", "GameServer\bin")
        $found = $false
        foreach ($path in $searchPaths) {
          if (Test-Path $path) {
            Write-Host "Checking: $path"
            Get-ChildItem -Path $path -Recurse -Filter "*.exe" | ForEach-Object {
              Write-Host "  Found: $($_.FullName)"
              $found = $true
            }
          }
        }
        if (-not $found) {
          Write-Host "⚠ GameServer.exe not found"
          Write-Host "Searching all .exe files:"
          Get-ChildItem -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }
        }
        
    - name: Upload GameServer.exe
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: GameServer
        path: |
          bin/**/*.exe
          **/bin/**/*.exe
          **/GameServer*.exe
        if-no-files-found: ignore
        retention-days: 30
